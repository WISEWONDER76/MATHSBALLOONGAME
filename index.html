<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Balloon Rescue | Premium Edition</title>
    <style>
        :root {
            --primary: #ff9800;
            --secondary: #2196f3;
            --danger: #f44336;
            --success: #4caf50;
            --bg-dark: #1a2a6c;
            --accent: #00d2ff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-attachment: fixed;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .header-section {
            text-align: center;
            padding: 20px 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            width: 100%;
            box-sizing: border-box;
        }

        .wiserobotics-brand {
            font-weight: 900;
            letter-spacing: 4px;
            font-size: 1rem;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wiserobotics-brand::before, .wiserobotics-brand::after {
            content: '';
            height: 2px;
            width: 20px;
            background: var(--accent);
        }

        h1 { 
            margin: 0; 
            font-size: 2rem; 
            letter-spacing: -1px; 
            background: linear-gradient(to right, #fff, #ff9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 15px;
            width: 95%;
            max-width: 1100px;
            margin: 10px auto;
            align-items: flex-start;
            box-sizing: border-box;
        }

        .side-panel {
            flex: 0 0 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .side-panel-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
            opacity: 0.6;
            margin-bottom: 5px;
            text-align: center;
        }

        .game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            min-width: 0;
        }

        #hud {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            box-sizing: border-box;
        }

        .stat-box { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.7; margin-bottom: 2px; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--primary); }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            max-height: 450px;
            background: linear-gradient(to bottom, #87ceeb 0%, #e0f7ff 100%);
            border: 4px solid #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            overflow: hidden;
            box-sizing: border-box;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.5;
            animation: moveClouds linear infinite;
        }

        @keyframes moveClouds {
            from { right: -200px; }
            to { right: 110%; }
        }

        #balloon {
            position: absolute;
            width: 80px;
            height: 110px;
            left: 50%;
            top: -120px;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .balloon-graphic {
            width: 70px;
            height: 85px;
            background: radial-gradient(circle at 30% 30%, #ff5252, #c62828);
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 900;
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .balloon-basket {
            width: 25px;
            height: 15px;
            background: #795548;
            border-radius: 2px;
            margin-top: 10px;
            position: relative;
        }

        #fireContainer {
            position: absolute;
            bottom: -5px;
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: space-around;
            z-index: 5;
        }

        .flame {
            width: 30px;
            height: 30px;
            background: #ff5722;
            border-radius: 50% 0 50% 50%;
            transform: rotate(-45deg);
            animation: flicker 0.1s infinite alternate;
        }

        @keyframes flicker {
            0% { transform: rotate(-45deg) scale(1); }
            100% { transform: rotate(-45deg) scale(1.1); background: #ffeb3b; }
        }

        #controls {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }

        input[type="number"] {
            flex: 1;
            padding: 12px;
            font-size: 1.5rem;
            border-radius: 12px;
            border: none;
            background: white;
            color: #333;
            outline: none;
            text-align: center;
            min-width: 0;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: 0.2s;
        }

        button.primary { background: var(--primary); color: white; }
        
        .mode-btn {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            padding: 12px;
            width: 100%;
            text-align: center;
        }

        .mode-btn.active {
            background: var(--secondary);
            border-color: var(--accent);
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            pointer-events: none;
            z-index: 100;
            width: 80%;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; width: 98%; }
            .side-panel {
                flex: none; width: 100%;
                display: grid; grid-template-columns: repeat(2, 1fr);
                gap: 8px; box-sizing: border-box;
            }
            .side-panel > .side-panel-title, 
            .side-panel > .volume-panel, 
            .side-panel > div:last-child { grid-column: span 2; }
            h1 { font-size: 1.8rem; }
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        }

        .confetti {
            position: absolute;
            width: 6px;
            height: 6px;
            z-index: 20;
            pointer-events: none;
        }
    </style>
</head>
<body onclick="enableAudio()">

<!-- Updated Audio Sources with public fallbacks -->
<audio id="bgMusic" loop preload="auto">
    <source src="https://actions.google.com/sounds/v1/science_fiction/techno_background.ogg" type="audio/ogg">
</audio>
<audio id="welcomeSound" preload="auto">
    <source src="welcome.mp3" type="audio/ogg">
</audio>
<audio id="loseSound" preload="auto">
    <source src="loose.wav" type="audio/ogg">
</audio>

<div class="header-section">
    <div class="wiserobotics-brand">WISEROBOTICS</div>
    <h1>BALLOON RESCUE</h1>
</div>

<div class="main-layout">
    <aside class="side-panel">
        <div class="side-panel-title">Subject</div>
        <button id="btn-add" class="mode-btn active" onclick="selectMode('add')">Addition</button>
        <button id="btn-sub" class="mode-btn" onclick="selectMode('sub')">Subtraction</button>
        <button id="btn-mul" class="mode-btn" onclick="selectMode('mul')">Multiplication</button>
        <button id="btn-div" class="mode-btn" onclick="selectMode('div')">Division</button>
        
        <div class="volume-panel" style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-top: 5px;">
            <div class="side-panel-title">Welcome Vol: <span id="welcomeVolDisplay">100%</span></div>
            <input type="range" id="welcomeVolSlider" min="0" max="1" step="0.05" value="1" oninput="updateWelcomeVolume(this.value)">
        </div>

        <div>
             <button class="primary" style="width: 100%; margin-top: 5px;" onclick="startGame()">START GAME</button>
        </div>
    </aside>

    <main class="game-wrapper">
        <div id="hud">
            <div class="stat-box"><span class="stat-label">Score</span><span id="score" class="stat-value">0</span></div>
            <div class="stat-box"><span class="stat-label">Level</span><span id="level" class="stat-value">1</span></div>
            <div class="stat-box"><span class="stat-label">Lives</span><span id="lives" class="stat-value">3</span></div>
            <div class="stat-box" style="grid-column: span 1;"><span class="stat-label">Best</span><span id="highScore" class="stat-value">0</span></div>
            <div class="stat-box" style="grid-column: span 2;">
                <span class="stat-label">Master Vol: <span id="masterVolDisplay">100%</span></span>
                <input type="range" id="masterVolSlider" min="0" max="1" step="0.05" value="1" oninput="updateMasterVolume(this.value)">
            </div>
        </div>

        <div id="gameContainer">
            <div id="balloon">
                <div class="balloon-graphic" id="problem">?</div>
                <div class="balloon-basket"></div>
            </div>
            <div id="fireContainer"></div>
            <div id="message"></div>
        </div>

        <div id="controls">
            <div class="input-group">
                <input type="number" id="answer" pattern="[0-9]*" inputmode="numeric" placeholder="?">
                <button class="primary" onclick="submitAnswer()">SUBMIT</button>
            </div>
        </div>
    </main>
</div>

<script>
    let score = 0, highScore = 0, level = 1, lives = 3, correctAnswer = 0, speed = 0.8, mode = "add", balloonY = -120;
    let gameInterval = null, isGameOver = false, masterVolume = 1.0, welcomeVolume = 1.0, welcomePlayed = false;

    const balloonEl = document.getElementById('balloon');
    const problemEl = document.getElementById('problem');
    const answerInput = document.getElementById('answer');
    const msgEl = document.getElementById('message');
    const gameContainer = document.getElementById('gameContainer');
    const bgMusic = document.getElementById('bgMusic');
    const welcomeSound = document.getElementById('welcomeSound');
    const loseSound = document.getElementById('loseSound');

    // Create background clouds
    for(let i=0; i<4; i++) createCloud();
    const fireContainer = document.getElementById('fireContainer');
    for(let i=0; i<8; i++) {
        const f = document.createElement('div');
        f.className = 'flame';
        f.style.animationDelay = (Math.random() * 0.5) + 's';
        fireContainer.appendChild(f);
    }

    function createCloud() {
        const cloud = document.createElement('div');
        cloud.className = 'cloud';
        const w = 50 + Math.random() * 80;
        cloud.style.width = w + 'px';
        cloud.style.height = (w * 0.4) + 'px';
        cloud.style.top = Math.random() * 60 + '%';
        cloud.style.animationDuration = (8 + Math.random() * 12) + 's';
        cloud.style.animationDelay = -(Math.random() * 10) + 's';
        gameContainer.appendChild(cloud);
    }

    // CRITICAL: Function to enable audio on first click
    function enableAudio() {
        if (!welcomePlayed) {
            welcomeSound.volume = welcomeVolume * masterVolume;
            welcomeSound.play().then(() => {
                welcomePlayed = true;
            }).catch(e => console.log("Audio block still in effect"));
        }
    }

    function selectMode(m) {
        mode = m;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${m}`).classList.add('active');
        if(!isGameOver && gameInterval) generateQuestion();
    }

    function generateQuestion() {
        let max = level * 6 + 4;
        let a, b;
        switch(mode) {
            case 'add': a = Math.floor(Math.random()*max)+1; b = Math.floor(Math.random()*max)+1; correctAnswer = a+b; problemEl.innerText = `${a}+${b}`; break;
            case 'sub': a = Math.floor(Math.random()*max)+max; b = Math.floor(Math.random()*max)+1; correctAnswer = a-b; problemEl.innerText = `${a}-${b}`; break;
            case 'mul': a = Math.floor(Math.random()*(level+1))+1; b = Math.floor(Math.random()*10)+1; correctAnswer = a*b; problemEl.innerText = `${a}ร${b}`; break;
            case 'div': b = Math.floor(Math.random()*8)+1; correctAnswer = Math.floor(Math.random()*10)+1; a = b*correctAnswer; problemEl.innerText = `${a}รท${b}`; break;
        }
    }

    function updateMasterVolume(val) {
        masterVolume = parseFloat(val);
        document.getElementById('masterVolDisplay').innerText = Math.round(masterVolume * 100) + "%";
        bgMusic.volume = masterVolume;
        loseSound.volume = masterVolume;
        welcomeSound.volume = welcomeVolume * masterVolume;
    }

    function updateWelcomeVolume(val) {
        welcomeVolume = parseFloat(val);
        document.getElementById('welcomeVolDisplay').innerText = Math.round(welcomeVolume * 100) + "%";
        welcomeSound.volume = welcomeVolume * masterVolume;
    }

    function startGame() {
        // Ensure audio can play
        enableAudio();
        
        if(gameInterval) clearInterval(gameInterval);
        score = 0; level = 1; lives = 3; speed = 0.8; isGameOver = false;
        msgEl.innerText = "";
        updateHUD();
        resetBalloon();
        
        bgMusic.volume = masterVolume;
        bgMusic.currentTime = 0;
        bgMusic.play().catch(e => console.log("Music play blocked", e));
        
        gameInterval = setInterval(update, 20);
        answerInput.focus();
    }

    function update() {
        if (isGameOver) return;
        balloonY += speed;
        balloonEl.style.top = balloonY + "px";
        balloonEl.style.transform = `translateX(-50%) translateX(${Math.sin(Date.now() / 400) * 10}px)`;
        if (balloonY > (gameContainer.offsetHeight - 140)) triggerMistake();
    }

    function triggerMistake() {
        lives--;
        updateHUD();
        gameContainer.classList.add('shake');
        setTimeout(() => gameContainer.classList.remove('shake'), 400);
        if (lives <= 0) endGame(); else resetBalloon();
    }

    function submitAnswer() {
        if (isGameOver || !answerInput.value) return;
        if (parseInt(answerInput.value) === correctAnswer) {
            celebrate();
            score++;
            if (score > highScore) highScore = score;
            if (score % 4 === 0) { level++; speed += 0.15; }
            updateHUD();
            resetBalloon();
        } else {
            answerInput.classList.add('shake');
            setTimeout(() => answerInput.classList.remove('shake'), 300);
        }
        answerInput.value = "";
        answerInput.focus();
    }

    function resetBalloon() {
        balloonY = -120;
        const range = gameContainer.offsetWidth - 100;
        balloonEl.style.left = (Math.random() * range + 50) + "px";
        generateQuestion();
    }

    function celebrate() {
        for(let i=0; i<8; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = balloonEl.offsetLeft + 40 + 'px';
            c.style.top = balloonEl.offsetTop + 40 + 'px';
            c.style.backgroundColor = `hsl(${Math.random()*360}, 80%, 60%)`;
            gameContainer.appendChild(c);
            let vx = (Math.random()-0.5)*8, vy = (Math.random()-0.5)*8, op = 1;
            const anim = setInterval(() => {
                c.style.left = (parseFloat(c.style.left)+vx)+'px'; 
                c.style.top = (parseFloat(c.style.top)+vy)+'px';
                op -= 0.03; c.style.opacity = op;
                if(op <= 0) { clearInterval(anim); c.remove(); }
            }, 20);
        }
    }

    function updateHUD() {
        document.getElementById("score").innerText = score;
        document.getElementById("level").innerText = level;
        document.getElementById("lives").innerText = lives;
        document.getElementById("highScore").innerText = highScore;
    }

    function endGame() {
        isGameOver = true;
        clearInterval(gameInterval);
        bgMusic.pause();
        
        // Play lose sound
        loseSound.volume = masterVolume;
        loseSound.currentTime = 0;
        loseSound.play().catch(e => console.log("Lose sound blocked", e));
        
        msgEl.innerHTML = `<div style="color:var(--danger)">GAME OVER</div><div style="font-size:1.2rem; color:white">Final Score: ${score}</div>`;
        balloonY = -200;
        balloonEl.style.top = balloonY + "px";
    }

    answerInput.addEventListener("keyup", (e) => e.key === "Enter" && submitAnswer());
</script>

</body>
</html>

